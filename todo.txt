Why-Combinator (YC): Product Requirements Document (Todo Format)
Tech Stack: Python CLI (Typer/Rich), TinyDB/JSON+SQLite, Ollama/Huggingface/LLM APIs, D3.js (future web UI)
Philosophy: Backend-first, local-first, CLI-driven with ASCII visualization. Research reproducibility + economic plausibility.
================================================================================











(B) Add relationship strength decay over time in agent/relationships.py: multiply strength by configurable decay_factor each tick if no reinforcing interaction +feature
(B) Add market saturation mechanic in engine/scenarios.py: adoption growth rate decreases as market_share approaches TAM ceiling +economics +feature
(B) Add diminishing returns to competitive_market: new entrants face increasing CAC as market becomes crowded +economics +feature
(B) Add agent behavioral invariant assertions in agent/base.py: configurable rules (e.g., cannot invest with 0 capital) that raise on violation during simulation +reproducibility +security

# DX/Utility: Library API, PyPI, CLI
(B) Refactor cli.py to be a thin wrapper: move all business logic from CLI command handlers into engine/ or a new src/why_combinator/api.py module +refactor
(B) Create src/why_combinator/api.py with public functions: create_simulation(), run_simulation(), list_simulations(), get_metrics(), export_simulation() callable without Typer +refactor +feature
(B) Create src/why_combinator/__init__.py that explicitly exports public API surface: SimulationEngine, create_simulation, run_simulation, LLMFactory, StorageManager +refactor
(B) Add py.typed marker file at src/why_combinator/py.typed for PEP 561 type stub support +infra
(B) Add full return type annotations to all public methods in engine/core.py (step, start, stop, checkpoint, restore) +refactor
(B) Add full type annotations to all public methods in agent/impl.py (perceive, reason, act, run_step) replacing Dict[str,Any] with typed dataclasses +refactor
(B) Add full type annotations to analytics.py and analytics_advanced.py public functions +refactor
(B) Add full type annotations to all LLM provider classes (completion, chat_completion return types; error union types) +refactor
(B) Replace Dict[str,Any] world_state with a typed WorldState dataclass in models.py containing date, timestamp, stage, agents, metrics, events +refactor
(B) Replace Dict[str,Any] interaction outcome with typed InteractionOutcome dataclass (thought_process, action_type, target, details, confidence) +refactor
(B) Add ProgressCallback protocol in api.py: on_tick(tick, metrics), on_phase_change(phase), on_complete(summary) for library consumers +feature
(B) Wire ProgressCallback into SimulationEngine.step() as optional injection alongside EventBus +feature
(B) Add pyproject.toml metadata: license, classifiers (Development Status, Topic, Python version), project-urls (homepage, repository, issues) +infra
(B) Add pyproject.toml long_description pointing to README.md with content-type text/markdown for PyPI page +infra
(B) Add version string to src/why_combinator/__init__.py and wire __version__ for programmatic access +infra
(B) Replace ad-hoc logging.getLogger() calls with a centralized configure_logging() in config.py supporting JSON structured output via LOG_FORMAT env var +infra
(B) Add structured log fields to engine step logging: simulation_id, tick, agent_id, action_type, duration_ms for machine-parseable logs +infra
(B) Add --log-format flag to CLI run command: "human" (default Rich) or "json" (structured) for pipeline integration +feature
(B) Add --output-dir flag to CLI run command allowing override of WHY_COMBINATOR_DATA_DIR per invocation +feature
(B) Add --dry-run flag to CLI new command that validates config and prints agent roster without persisting +feature

# Stability/Scaling: Async, Storage, Error Handling, Tests
(B) Convert SimulationEngine.step() to async; use asyncio.gather() with semaphore to run agent.run_step() concurrently with configurable max_concurrent param +performance
(B) Convert all LLM provider completion() methods to async using httpx.AsyncClient instead of httpx.Client +performance
(B) Add async_completion() implementation to AnthropicProvider and HuggingfaceProvider matching OllamaProvider pattern +performance
(B) Add asyncio.Semaphore to engine tick loop limiting concurrent LLM calls to prevent API rate limit exhaustion +performance +security
(B) Implement SQLite storage backend as new class SqliteStorageManager in storage.py implementing StorageManager ABC +feature +infra
(B) Add SQLite schema: simulations table (id, name, industry, stage, config_json, created_at), agents table (id, sim_id, type, personality_json), interactions table (id, sim_id, agent_id, tick, action_type, details_json, timestamp), metrics table (sim_id, tick, metric_type, value, timestamp) +feature +infra
(B) Add SQLite indexes on interactions(sim_id, tick), metrics(sim_id, metric_type), agents(sim_id) for cross-sim query performance +performance +infra
(B) Add storage backend selector in config.py: STORAGE_BACKEND=tinydb|sqlite defaulting to sqlite for new installs +infra
(B) Add TinyDB-to-SQLite migration script as CLI subcommand: why-combinator migrate --from tinydb --to sqlite +feature +infra
(B) Add cross-simulation SQL query support: StorageManager.query_metrics(filters: MetricFilter) returning aggregated results across simulations +feature
(B) Add agent memory eviction policy in agent/base.py: configurable max_memory_size; when exceeded, summarize oldest N memories into single summary entry +performance +feature
(B) Add memory summarization prompt in agent/prompts.py for LLM-based memory compression when eviction triggers +feature
(B) Add inbox size cap to BaseAgent (default 50); drop oldest unread messages when exceeded with warning log +performance
(B) Add sentiment_tracker history pruning: keep only last N ticks of history per agent (configurable, default 200) +performance
(B) Add Pydantic or manual validation to SimulationEntity fields in models.py: stage must be valid SimulationStage, industry non-empty, name length 1-100 +security
(B) Add LLM response schema validation in agent/impl.py reason(): check required keys (action_type, thought_process) exist; retry once with explicit schema reminder if missing +security +feature
(B) Add JSON schema definition for expected agent LLM response format in agent/prompts.py; include in system prompt for structured output guidance +security
(B) Standardize retry logic across all LLM providers: extract RetryPolicy(max_retries, backoff_base, retryable_status_codes) into llm/base.py; apply uniformly +refactor +security
(B) Add retry logic to AnthropicProvider.completion() matching OpenAI pattern (3 retries, exponential backoff on 429/500/503) +security
(B) Add graceful API key validation in LLMFactory.create(): check env var exists before instantiation; raise ConfigError with clear message naming the missing key +security
(B) Add LLM provider fallback chain in LLMFactory: if primary fails init (missing key), try next in chain (openai -> ollama -> mock) with warning log +feature +security
(B) Add threading.Lock to BatchWriter._buffer operations (add, flush) to prevent concurrent modification +security
(B) Register BatchWriter.flush() with atexit module in engine/core.py to prevent data loss on unclean shutdown +security
(B) Add wall-clock timeout to SimulationEngine.run(): configurable max_wall_seconds; emit warning and stop gracefully when exceeded +security +feature
(B) Add test: CLI new command creates simulation with correct metadata and spawned agents (integration test using CliRunner) +test
(B) Add test: CLI run command executes N ticks with mock LLM and produces expected metric count +test
(B) Add test: CLI export command generates valid JSON/CSV/Markdown output files +test
(B) Add test: OllamaProvider retries on 429 status and succeeds on subsequent attempt (mock httpx) +test
(B) Add test: OpenAIProvider exponential backoff timing is correct across 3 retries (mock httpx) +test
(B) Add test: AnthropicProvider handles missing API key with clear ConfigError +test
(B) Add test: CachedLLMProvider returns identical response for identical prompt+model (determinism) +test
(B) Add test: GenericAgent falls back to wait action when LLM returns malformed JSON +test
(B) Add test: GenericAgent.perceive() handles missing world_state keys without KeyError +test
(B) Add test: RelationshipGraph strength decays correctly over N ticks without interaction +test
(B) Add test: CoalitionManager detects coalition when 3+ agents have mutual positive relationships +test
(B) Add test: SentimentTracker correctly scores positive/negative/neutral actions +test
(B) Add test: EmergenceDetector flags repeated action pattern as emergent behavior +test
(B) Add test: MultiPhaseManager transitions from mvp to launch when adoption threshold met +test
(B) Add test: BatchWriter flushes all buffered interactions on explicit flush() call +test
(B) Add test: AgentPool rotates agents correctly when pool size exceeds active limit +test
(B) Add test: ExperimentConfig diff correctly identifies changed variables between two configs +test
(B) Add test: cross-simulation metric aggregation returns correct mean/stddev across 3 mock sims +test
(B) Add test: market saturation mechanic reduces adoption growth rate as market_share approaches TAM +test
(B) Add test: agent memory eviction keeps max_memory_size entries and summarizes overflow +test
(B) Add test: LLM provider fallback chain activates mock when no API keys are configured +test
(B) Add pytest-asyncio to dev dependencies and async test fixtures for async engine tests +test +infra
(B) Add mypy to dev dependencies; create mypy.ini with strict mode for src/why_combinator/ +infra
(B) Add pre-commit hook running mypy and pytest via pyproject.toml scripts entry +infra

# Stretch Goals: Web UI & PostgreSQL
(STRETCH) Implement PostgreSQL storage backend as alternative to TinyDB
(STRETCH) Create database migration scripts from TinyDB to PostgreSQL
(STRETCH) Build FastAPI REST backend exposing simulation engine
(STRETCH) Create React+TypeScript web frontend with D3.js 2D visualizations
(STRETCH) Implement WebSocket connection for real-time web updates
(STRETCH) Implement API for external tool integration
