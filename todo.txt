Why-Combinator (YC): Product Requirements Document (Todo Format)
Tech Stack: Python CLI (Typer/Rich), TinyDB/JSON+SQLite, Ollama/Huggingface/LLM APIs, D3.js (future web UI)
Philosophy: Backend-first, local-first, CLI-driven with ASCII visualization. Research reproducibility + economic plausibility.
================================================================================

# Stability/Scaling: Async, Storage, Error Handling, Tests
(B) Add storage backend selector in config.py: STORAGE_BACKEND=tinydb|sqlite defaulting to sqlite for new installs +infra
(B) Add TinyDB-to-SQLite migration script as CLI subcommand: why-combinator migrate --from tinydb --to sqlite +feature +infra
(B) Add cross-simulation SQL query support: StorageManager.query_metrics(filters: MetricFilter) returning aggregated results across simulations +feature
(B) Add agent memory eviction policy in agent/base.py: configurable max_memory_size; when exceeded, summarize oldest N memories into single summary entry +performance +feature
(B) Add memory summarization prompt in agent/prompts.py for LLM-based memory compression when eviction triggers +feature
(B) Add inbox size cap to BaseAgent (default 50); drop oldest unread messages when exceeded with warning log +performance
(B) Add sentiment_tracker history pruning: keep only last N ticks of history per agent (configurable, default 200) +performance
(B) Add Pydantic or manual validation to SimulationEntity fields in models.py: stage must be valid SimulationStage, industry non-empty, name length 1-100 +security
(B) Add LLM response schema validation in agent/impl.py reason(): check required keys (action_type, thought_process) exist; retry once with explicit schema reminder if missing +security +feature
(B) Add JSON schema definition for expected agent LLM response format in agent/prompts.py; include in system prompt for structured output guidance +security
(B) Standardize retry logic across all LLM providers: extract RetryPolicy(max_retries, backoff_base, retryable_status_codes) into llm/base.py; apply uniformly +refactor +security
(B) Add retry logic to AnthropicProvider.completion() matching OpenAI pattern (3 retries, exponential backoff on 429/500/503) +security
(B) Add graceful API key validation in LLMFactory.create(): check env var exists before instantiation; raise ConfigError with clear message naming the missing key +security
(B) Add LLM provider fallback chain in LLMFactory: if primary fails init (missing key), try next in chain (openai -> ollama -> mock) with warning log +feature +security
(B) Add threading.Lock to BatchWriter._buffer operations (add, flush) to prevent concurrent modification +security
(B) Register BatchWriter.flush() with atexit module in engine/core.py to prevent data loss on unclean shutdown +security
(B) Add wall-clock timeout to SimulationEngine.run(): configurable max_wall_seconds; emit warning and stop gracefully when exceeded +security +feature
(B) Add test: CLI new command creates simulation with correct metadata and spawned agents (integration test using CliRunner) +test
(B) Add test: CLI run command executes N ticks with mock LLM and produces expected metric count +test
(B) Add test: CLI export command generates valid JSON/CSV/Markdown output files +test
(B) Add test: OllamaProvider retries on 429 status and succeeds on subsequent attempt (mock httpx) +test
(B) Add test: OpenAIProvider exponential backoff timing is correct across 3 retries (mock httpx) +test
(B) Add test: AnthropicProvider handles missing API key with clear ConfigError +test
(B) Add test: CachedLLMProvider returns identical response for identical prompt+model (determinism) +test
(B) Add test: GenericAgent falls back to wait action when LLM returns malformed JSON +test
(B) Add test: GenericAgent.perceive() handles missing world_state keys without KeyError +test
(B) Add test: RelationshipGraph strength decays correctly over N ticks without interaction +test
(B) Add test: CoalitionManager detects coalition when 3+ agents have mutual positive relationships +test
(B) Add test: SentimentTracker correctly scores positive/negative/neutral actions +test
(B) Add test: EmergenceDetector flags repeated action pattern as emergent behavior +test
(B) Add test: MultiPhaseManager transitions from mvp to launch when adoption threshold met +test
(B) Add test: BatchWriter flushes all buffered interactions on explicit flush() call +test
(B) Add test: AgentPool rotates agents correctly when pool size exceeds active limit +test
(B) Add test: ExperimentConfig diff correctly identifies changed variables between two configs +test
(B) Add test: cross-simulation metric aggregation returns correct mean/stddev across 3 mock sims +test
(B) Add test: market saturation mechanic reduces adoption growth rate as market_share approaches TAM +test
(B) Add test: agent memory eviction keeps max_memory_size entries and summarizes overflow +test
(B) Add test: LLM provider fallback chain activates mock when no API keys are configured +test
(B) Add pytest-asyncio to dev dependencies and async test fixtures for async engine tests +test +infra
(B) Add mypy to dev dependencies; create mypy.ini with strict mode for src/why_combinator/ +infra
(B) Add pre-commit hook running mypy and pytest via pyproject.toml scripts entry +infra